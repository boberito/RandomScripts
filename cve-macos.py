#!/usr/bin/env python3

import re
import urllib3
import json
import requests

urllib3.disable_warnings()

def main():
    url = "https://support.apple.com/en-us/HT213940"    
    r = requests.get(url)
    contents = str(r.content)
    regex = r"CVE-202[0-9]-[0-9][0-9][0-9][0-9][0-9]"
    matches = re.finditer(regex, contents, re.MULTILINE)
    monterey = []
    ventura = []
    sonoma = []
    for matchNum, match in enumerate(matches, start=1):

        nvdurl = "https://services.nvd.nist.gov/rest/json/cves/2.0?cveId={}".format(match.group())
        nvdRequest = requests.get(nvdurl)
        data = json.loads(nvdRequest.content.decode('utf-8'))
        for vulnerable in data['vulnerabilities']:
            
            if "configurations" not in vulnerable['cve']:
                continue
            severity = str()
            score = float()
            for metric in vulnerable['cve']['metrics']['cvssMetricV31']:
                severity = metric['cvssData']['baseSeverity']
                score = metric['cvssData']['baseScore']
                
            for config in vulnerable['cve']['configurations']:
                # print(config)
                for node in config['nodes']:
                    print("-----------------------------------------------")
                    print("\t\t{}".format(match.group()))
                    print("Severity: {}".format(severity))
                    print("Score: {}".format(score))
                    for cpematch in node['cpeMatch']:
                        if "versionEndExcluding" not in cpematch:
                            continue
                        if "tvos" in cpematch['criteria'] or "iphone_os" in cpematch['criteria'] or "ipados" in cpematch['criteria'] or "watchos" in cpematch['criteria']:
                            continue
                        
                        if "safari" in cpematch['criteria']:
                            print("- Fixed in Safari {}".format(cpematch['versionEndExcluding']))
                        if "12" in cpematch['versionEndExcluding']:                            
                            print("- fixed in Monterey {}".format(cpematch['versionEndExcluding']))
                        if "13" in cpematch['versionEndExcluding']:    
                            print("- fixed in Ventura {}".format(cpematch['versionEndExcluding']))
                        if "versionStartIncluding" in cpematch:
                            if "14" in cpematch['versionEndExcluding'] and "13" in cpematch['versionStartIncluding'] or "14" in cpematch['versionEndExcluding'] and "12" in cpematch['versionStartIncluding']:
                                print("*** macOS {} is vulnerable ***".format(cpematch['versionStartIncluding']))
                            
                    print("- fixed in Sonoma")                    

if __name__ == "__main__":
    main()
